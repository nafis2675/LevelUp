generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Badge {
  id          String        @id
  companyId   String
  name        String
  description String
  imageUrl    String
  rarity      String        @default("common")
  requirement Json
  isActive    Boolean       @default(true)
  isSecret    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  Company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  MemberBadge MemberBadge[]

  @@index([companyId])
}

model Company {
  id          String        @id
  name        String
  ownerId     String
  settings    Json          @default("{}")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  Badge       Badge[]
  Leaderboard Leaderboard[]
  Member      Member[]
  Reward      Reward[]
  XPRule      XPRule[]

  @@index([ownerId])
}

model Leaderboard {
  id        String   @id
  companyId String
  name      String
  type      String
  timeframe String   @default("all_time")
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Member {
  id               String          @id
  whopUserId       String
  whopMembershipId String
  companyId        String
  displayName      String
  avatarUrl        String?
  totalXP          Int             @default(0)
  level            Int             @default(1)
  currentLevelXP   Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  lastActivityAt   DateTime        @default(now())
  Company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  MemberBadge      MemberBadge[]
  RewardClaim      RewardClaim[]
  XPTransaction    XPTransaction[]

  @@unique([whopUserId, companyId])
  @@index([companyId, totalXP])
  @@index([whopMembershipId])
}

model MemberBadge {
  id       String   @id
  memberId String
  badgeId  String
  earnedAt DateTime @default(now())
  progress Int      @default(100)
  Badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  Member   Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, badgeId])
  @@index([badgeId])
  @@index([memberId])
}

model Reward {
  id             String        @id
  companyId      String
  name           String
  description    String
  type           String
  config         Json
  requiredLevel  Int?
  requiredXP     Int?
  requiredBadges Json?
  isActive       Boolean       @default(true)
  isRepeatable   Boolean       @default(false)
  cooldownDays   Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  Company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  RewardClaim    RewardClaim[]

  @@index([companyId])
}

model RewardClaim {
  id        String   @id
  memberId  String
  rewardId  String
  claimedAt DateTime @default(now())
  status    String   @default("pending")
  Member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  Reward    Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([rewardId])
}

model XPRule {
  id         String   @id
  companyId  String
  name       String
  eventType  String
  xpAmount   Int
  cooldown   Int      @default(0)
  maxPerDay  Int      @default(0)
  isActive   Boolean  @default(true)
  conditions Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, eventType])
}

model XPTransaction {
  id        String   @id
  memberId  String
  amount    Int
  reason    String
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
  Member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([memberId, createdAt])
}
